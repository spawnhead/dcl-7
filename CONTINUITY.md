Goal (incl. success criteria):
- Finalize Margin screen specs (CONTRACTS + ACCEPTANCE [+ MATRIX]) based on existing snapshot artifacts to enable 1:1 implementation without guessing.

Constraints/Assumptions:
- Do not modify legacy code in `src/` unless necessary.
- Use Java 21, Spring Boot 3.5.x, Spring Modulith, Flyway, Postgres.
- Start each step by reading/updating this file.

Key decisions:
- **TECH_STACK приоритет (2026-02-22):** docs/TECH_STACK.md — источник истины для стека. DEVELOPMENT_HANDOFF, AGENTS, правила приведены в соответствие. Frontend: TanStack Router, Radix UI, Tailwind, @tanstack/react-table.
- **Next screen: Contractors list (2026-02-12):** References → Контрагенты. Унификация contractor_create: один домен, list + create/edit; returnTo=contractors vs returnTo=contract. Spec pack: docs/screens/contractors/. Plan: logs/plan-next-screen-contractors-20260212-1900.md.
- **DCL_CONTRACT_FILTER (2026-02-11):** Реализация в application layer; Postgres FUNCTION не создаётся. Детали: docs/db/DCL_CONTRACT_FILTER_DECISION.md.
- **N3 reopened (2026-02-11):** Parity gap — missing 2 buttons: «Импорт из КП» (ContractsAction.do?dispatch=selectCP&minsk_store=1), «Создать» (ContractAction.do?dispatch=input). Legacy: Contracts.jsp lines 123–128. Plan patch specs → Dev implement → QA re-verify.
- N3 selected for current Agent-Plan cycle: Contracts list screen spec pack.
- First vertical slice domain: Country reference data (`DCL_COUNTRY`).
- Build tool: Maven.
- **N2 screen (after Margin):** Orders list (Заказы — список заказов). Justification: maximum complexity among list screens (many filters, dependent lookups, role-based edit/block, grid from `dcl_order_filter`), high business value; full traceability in src (OrdersAction, OrdersForm, Orders.jsp, select-orders SQL, OrderDAO, validation.xml, xml-permissions). Alternative candidates: Contracts list, Shippings list, Payments list, Produce Cost report.

State:
- Full E2E validated (2026-02-09): Docker Desktop + Postgres (docker compose up) + backend (JAVA_HOME=JDK 21, spring-boot:run) + OpenAPI /v3/api-docs + UI generate:api + npm run dev (Vite 5173/5174). Backend requires JDK 21 and flyway-database-postgresql for Postgres 16; Modulith event_publication/event_publication_archive tables via Flyway V3/V4. Actuator/health not exposed by default.
- Stage: development (local E2E). Production: not deployed; no production environment or release process yet.

Done:
- 2026-02-22: Contractors backend permission guardrails: admin role now required for create/edit open/save endpoints (not only block/delete); controller tests expanded with forbidden USER cases; contractor form API calls now pass X-Role from session.
- 2026-02-22: Contractors permissions parity baseline: backend lookups now returns explicit `permissions` (canCreate/canEdit/canBlock/canDelete) by role; contractors list UI consumes permissions from `/lookups` and disables Create/Edit/Block/Delete actions accordingly.
- 2026-02-22: Contractors nested grids persistence parity: Flyway V5 (dcl_account/dcl_contact_person/dcl_contractor_user), backend child entities/repositories + create/edit sync/read/delete, DTO расширены users/accounts/contactPersons; UI payload/state переведены на typed nested rows; service/controller tests покрывают validation и persistence flow.
- 2026-02-22: Contractor form hardening: 5-tab UI layout, tab-level validation markers, account rules baseline validation, backend duplicate UNP check (400) + ContractorService unit tests.
- 2026-02-22: Contractors create/edit baseline: backend endpoints `create/open|save`, `{id}/edit/open|save`; UI routes `/references/contractors/new`, `/references/contractors/$ctrId/edit`; list actions Создать/Изменить.
- 2026-02-22: Старт реализации Contractors list (ready spec): Flyway V4 `dcl_contractor`, backend list/block/delete + lookups/data endpoints, UI route `/references/contractors` (filters/grid/pager), WebMvc tests.
- 2026-02-22: Добавлен Auth baseline + TanStack Router split: backend `POST /api/auth/login`, WebMvc auth tests, UI login `/login`, protected routes `/references/countries|currencies`, session/logout flow.
- 2026-02-22: Реализован currencies vertical slice (Loop): Flyway V3 `dcl_currency`, backend CRUD `/api/currencies`, WebMvc tests, UI переключение справочников (Countries/Currencies) и CRUD валют.
- 2026-02-22: Реализован countries vertical slice (Phase 0): Flyway V2 `dcl_country`, backend CRUD `/api/countries` (api/application/domain/infrastructure), API exception handler, WebMvc tests, UI CRUD экран "Справочник стран" + Vite proxy/strictPort.
- 2026-02-22: Запущен bootstrap modern-проекта по docs/DEVELOPMENT_HANDOFF.md: создан каркас `modern/backend` (Spring Boot 3.5, Modulith starter, Flyway, OpenAPI, `/api/bootstrap/status`), `modern/ui` (React 19 + Vite + TS + Tailwind), `ops/docker-compose.yml` (Postgres 16), `modern/README.md` с дальнейшими шагами.
- 2026-02-22: AGENTS.md создан по стандарту [agents.md](https://github.com/agentsmd/agents.md) для Codex: Start Here, Dev tips, Commands, Testing, Per-Screen Workflow, Definition of Done, Forbidden; ссылка на DEVELOPMENT_HANDOFF как основной PRD.
- 2026-02-22: docs/DEVELOPMENT_HANDOFF.md переписан по принципам ERP PRD (brownfield clean-room): Goal/Personas/Scope/User flows/FR/NFR/Acceptance criteria/Evidence/Риски/Что уточнить у бизнеса; shadcn/ui + Tailwind; Evidence для каждого правила.
- 2026-02-21: SQL Deep Dive loop complete: all `needs_sql_review` screens re-evaluated and returned to `ready` with SQL alignment sections (schema/constraints/triggers/procedures).
- 2026-02-21: SQL Patch Applied (PHASE 0.5): all previously ready screens moved to `needs_sql_review` for mandatory SQL re-evaluation.
- 2026-02-21: PRD MVP Module 1 переработан по замечаниям: усилена evidence-база, добавлены явные источники по формулам/статусам/ролям, уточнены риски с modern recommendations.
- 2026-02-21: Сформирован PRD для MVP Module 1 (КП/справочники/договоры) на основе reverse-engineering legacy: docs/PRD_MVP_Module1.md.
- 2026-02-20: Loop normalization pass: ensured required files (`spec.md`, `api.contract.md`, `db.invariants.md`, `evidence.md`, `questions.md`, `review.md`) exist for all ready screen folders.
- 2026-02-20: LOOP MODE completed: processed remaining 153 screens from SPECS_INDEX todo, generated/updated spec packs, set CYCLE_STATE status DONE, todo count = 0.
- 2026-02-20: Legacy doc loop resumed: processed `admzone` screen spec pack (spec/api/db/evidence/questions/review), moved `admzone` to ready in SCREENS/SPECS indexes, updated CYCLE_STATE (next `assemble`).
- 2026-02-20: Legacy doc loop resumed: processed `actions` screen spec pack (spec/api/db/evidence/questions/review), moved `actions` to ready in SCREENS/SPECS indexes, updated CYCLE_STATE (next `admzone`).
- 2026-02-20: Legacy doc loop resumed: processed `actionroles` screen spec pack (spec/api/db/evidence/questions/review), moved `actionroles` to ready in SCREENS/SPECS indexes, updated CYCLE_STATE (next `actions`).
- 2026-02-20: Legacy doc loop resumed: processed `action` screen spec pack (spec/api/db/evidence/questions/review), moved `action` to ready in SCREENS/SPECS indexes, updated CYCLE_STATE (next `actionroles`).
- 2026-02-20: Legacy full-screen doc generator checkpoint: initialized docs/SCREENS_INDEX.md, docs/SCREENS_REGISTRY.md, docs/SPECS_INDEX.md, docs/CYCLE_STATE.md, docs/screens/README.md; processed screen `payments` with full spec pack (spec/api/db/evidence/questions/review); backlog synchronized from JSP inventory.
- 2026-02-13: TASK-0092 Orders design integration: OrdersPage + OrderEditPage layout per Create Contract Redesign; Card filters, sections, sticky footer; parity сохранён; Build PASS.
- 2026-02-13: TASK-0090 Orders CERT: Playwright 2 passed (full flow NOT skip); endpoints 2xx; Console 0. logs/qa-task-0090-orders-cert-20260213-0900.md.
- 2026-02-13: TASK-0087 Playwright E2E smoke: orders-smoke.spec.ts, cp-list-smoke.spec.ts; 3 passed, 1 skipped (Orders full BLOCKED by backend save 500). logs/qa-task-0087-playwright-smokes-20260213-0540.md.
- 2026-02-13: TASK-0089 Orders save 500 fix: ord_number VARCHAR(15) truncation in OrderEditService; smoke test fixes; Playwright orders-smoke 2 passed. logs/dev-task-0089-orders-save-500-fix-20260213-0830.md.
- 2026-02-13: TASK-0088 Orders edit/open 404 fix: killed old 8080 process; clean build + restart; GET /api/orders/edit/open 200. QA BLOCKED (TASK-0085) resolved. logs/dev-task-0088-orders-open-404-fix-20260213-0825.md.
- 2026-02-13: TASK-0086 MCP rule Playwright + Chrome DevTools: .cursor/rules/090-mcp-usage.mdc переписано; Playwright MCP — стандартный QA/Smoke/E2E (https://github.com/microsoft/playwright-mcp); разделение Playwright (автоматизация/регрессия) vs Chrome DevTools (диагностика); чеклисты и правила; без таблиц, без бинарей. logs/dev-task-0086-mcp-rule-playwright-devtools-20260213-1220.md.
- 2026-02-13: TASK-0083 Orders AJAX grids: Flyway V29 (dcl_ord_list_payment, dcl_ord_list_pay_sum); Backend OrderPayment/OrderPaySum, open/save; UI OrderEditPage График оплаты + Суммы оплаты. logs/dev-task-0083-orders-ajax-grids-20260213-0815.md.
- 2026-02-12: TASK-0084 Commercial Proposals list 1:1: Backend V26 dcl_commercial_proposal + dcl_cpr_list_produce, V27 dev seed (contractors + CPs), V28 fix cpr_proposal_declined type; CommercialProposalsController/Service/CpListProvider (Postgres-only); UI CommercialProposalsPage (/commercial-proposals), 10 filters, grid, row actions (Edit/Clone new|old/Block), blocked-row strikethrough; clone creates copy, block toggles. logs/dev-task-0084-cp-list-20260212-2252.md.
- 2026-02-12: TASK-0081 Legacy HAR capture: 7 экранов (contracts, contractors, contractor_create, contractor_edit, contract_import_cp, contract_spec_create, contract_attachments). Legacy http://localhost:8082/ доступен; POST ContractsAction.do?dispatch=filter|input|selectCP; POST ContractorsAction.do?dispatch=filter; GET ContractorAction.do?dispatch=create|edit. Все BLOCKED.md заменены на network.har (текстовый артефакт). CONTRACTS.md обновлены. logs/qa-task-0081-legacy-har-capture-20260212-1915.md.
- 2026-02-12: TASK-0082 Orders list Postgres-only: OrderListProvider (dcl_order + JOINs), OrdersService list + lookups из OrderLookupsRepository; OrderFilterFakeProvider удалён. logs/dev-task-0082-orders-list-postgres-only-20260212-2245.md.
- 2026-02-12: TASK-0080 Orders create/edit 1:1: Flyway V25 (dcl_order, dcl_ord_list_produce, dcl_stuff_category, dcl_blank); OrderEditService (open/save); GET/POST/PUT /api/orders/edit/open|save; OrderEditPage (/orders/new, /orders/:id/edit); Postgres-only lookups. logs/dev-task-0080-orders-create-edit-20260212-2210.md.
- 2026-02-12: TASK-0079 Orders and Commercial Proposals spec packs: docs/screens/order_edit/*, docs/screens/commercial_proposals/*, docs/screens/commercial_proposal_edit/* (SNAPSHOT/CONTRACTS/ACCEPTANCE/BEHAVIOR_MATRIX/TEST_DATA_SPEC/QA_ROLE_PRESETS/payloads). Three screen modes for CP (Regular, Old Version, Minsk Store). All network payloads BLOCKED pending HAR capture. logs/plan-task-0079-orders-and-cp-specs-20260212-2104.md.
- 2026-02-12: TASK-0078 Evidence pack for next screens: scripts/orchestrator-evidence.sh → logs/orchestrator-evidence-draft.md. logs/plan-task-0078-evidence-pack-20260212-1835.md.
- 2026-02-12: TASK-0073 Admin Badge for Block: маркировка «Блок» через Badge (999+) при adminRole/isAdmin на /contractors, /contractors/:id/edit, /contractors/new и в ContactPersonsModal. logs/dev-task-0073-admin-badge-block-20260212-1645.md.
- 2026-02-12: TASK-0072 Contractor Edit parity: BUG-1 — ctrBankProps/ctrComment added to edit save payload (ContractorEditPage); BUG-2 — Contact person edit modal prefill via Form key + initialValues (ContactPersonsModal). logs/dev-task-0072-contractor-edit-bank-and-contact-persons-20260212-1615.md.
- 2026-02-12: Env unblock (Flyway): port 8080 killed; docker compose down -v + up -d; backend dev profile started; api-docs confirms edit/open, edit/save. logs/dev-flyway-unblock-20260212-1820.md.
- 2026-02-12: Agent-Dev TASK-0071 Contractor Edit 1:1: GET/PUT edit/open, edit/save; ContractorEditService (Postgres); ContractorEditPage (tabs, returnTo, formReadOnly, roleFlags, 404); route contractors/:id/edit. Build PASS. Env unblocked; browser verification next.
- 2026-02-12: Agent-Plan TASK-0070 Contractor Edit Spec Pack 1:1: docs/screens/contractor_edit/ (SNAPSHOT/CONTRACTS/ACCEPTANCE/BEHAVIOR_MATRIX/TEST_DATA_SPEC/QA_ROLE_PRESETS/payloads). Full legacy traceability to ContractorAction#edit/editCommon/process/delete. UNCONFIRMED: delete Popconfirm text, occupied check logic. logs/plan-contractor-edit-20260212-1500.md.
- 2026-02-12: Agent-Dev TASK-0068 Global action confirmations: success notification с entity context (ctrName/conNumber); setFlashSuccess/consumeFlash; Apply/Clear/Delete feedback; rule 080. logs/dev-task-0068-global-confirmations-20260212-1300.md — Build PASS.
- 2026-02-12: Agent-Dev TASK-0066 contractor_create Contact persons Postgres persistence: V24 dcl_contact_person, JPA Entity+Repository, ContractorCreateService save/open; integration test; E2E VERIFIED (ctrId=33, Postgres 1 row). logs/dev-task-0066-contact-persons-persist-20260212-1206.md.
- 2026-02-12: Agent-Dev TASK-0067 contractor_create Contact persons UX polish: Modal required/email/maxlen, notifyError on validation fail, notifySuccess on add/edit. logs/dev-task-0067-contact-persons-modal-20260212-1000.md — Build PASS.
- 2026-02-12: Agent Release Manager TASK-0063 Post-fix audit /contracts/new: diff 59902b17/722e6b01/b43bcbec; бизнес-логика и API не изменены; parity сохранён; Build PASS; open 200; anti-patterns в логе. logs/audit-task-0063-claude-opus-contract-create-fix-20260212-1200.md — VERIFIED.
- 2026-02-11: Agent-Dev TASK-0058 Contractors list grid missing fields: V22+V23 dev seed миграции заполняют address/phone/email/bank_props для contractors на первой странице; API возвращает данные; backend mapper без изменений. logs/dev-task-0058-contractors-grid-missing-fields-20260211-2359.md.
- 2026-02-11: Agent-Debug TASK-0057 contractor_create redirect regression check: NO REGRESSION. Both scenarios (returnTo=contractors, returnTo=contract) PASS. TASK-0054 fix verified. logs/debug-task-0057-contractor-redirect-20260211-2100.md.
- 2026-02-09: Agent-Dev TASK-0056 Chrome DevTools MCP: docs/MCP_SETUP.md §2.5 §5.5, .cursor/rules/090-mcp-usage.mdc, AGENT_TASK_REPORTS MCP Evidence. logs/dev-chrome-devtools-mcp-setup-20260209-1430.md.
- 2026-02-11: Agent-Debug TASK-0054 contractor_create wrong redirect: returnTo default path-based (contractors for /contractors/new); save body prefer openData.returnTo. logs/debug-contractor-wrong-redirect-20260211-2025.md — VERIFIED.
- 2026-02-11: Agent-Dev TASK-0050 MCP UI Components: локальная установка ops/mcp-antd/, extract компонентов, mcp.json → node + путь; docs/MCP_SETUP.md.
- 2026-02-11: Agent-Dev TASK-0049 contractor_create Contact persons UX via Modal: read-only table, Add/Edit через Modal, Delete + Popconfirm. ContactPersonsModal.tsx. logs/dev-contact-persons-modal-20260211-2230.md — VERIFIED.
- 2026-02-11: Agent-Dev TASK-0048 Contractors list delete + Popconfirm + icons + contractor_create Contact persons tab + success feedback «Контрагент успешно сохранен». DELETE /api/contractors/{ctrId}; gridContactPersons в save. logs/dev-contractors-delete-contacts-20260211-2205.md — VERIFIED.
- 2026-02-11: Agent-Dev TASK-0047 MCP Command Cookbook: docs/MCP_SETUP.md §5 — Postgres/Docker/Playwright/GitHub сценарии, PASS/FAIL, Minimum MCP Evidence, copy-paste block. logs/dev-mcp-cookbook-20260211-2250.md.
- 2026-02-11: Agent-Plan TASK-0046 Contractors list + contractor_create parity patch: delete Popconfirm + icons, contact persons tab parity, save success feedback. Specs updated in docs/screens/contractors/* and docs/screens/contractor_create/*. Log: logs/plan-contractors-delete-and-contacts-parity-20260211-2153.md.
- 2026-02-11: Agent-Dev TASK-0045 MCP setup: docs/MCP_SETUP.md, .env.example, rule 090-mcp-usage.mdc, MCP Evidence template; no secrets in git. logs/dev-mcp-setup-20260211-2215.md.
- 2026-02-11: Agent-QA TASK-0044 Contractors list parity: **PASS**. ACCEPTANCE B1–B6 verified; Network 2xx; Console 0. logs/qa-contractors-list-20260211-2130.md.
- 2026-02-11: Agent-Dev TASK-0043 Contractors list: GET lookups, POST data/page/cleanAll/block; Postgres-only; UI ContractorsPage, фильтры, grid wrapper, menu Справочники→Контрагенты. logs/dev-contractors-list-20260211-2120.md — VERIFIED (implementation).
- 2026-02-11: Agent-Dev TASK-0038 Contracts grid theme align: shared table wrapper; Layout.Content+app-content для Contracts; все 4 грида через wrapper; rule 081-tables-standard.mdc. logs/dev-contracts-grid-theme-align-20260211-2200.md — VERIFIED.
- 2026-02-12: Agent-Dev TASK-0034 Global feedback notification: notifySuccess/notifyError для save; применён к N3a и N3a1; Skeleton min 350ms в DEV; rule 080 обновлён. logs/dev-notification-feedback-global-20260212-2030.md — VERIFIED.
- 2026-02-12: Agent-Debug grid dark parity fix: Layout в Contracts/Orders имел светлый фон; добавлен dark theme для app-content. logs/fix-aggrid-dark-theme-parity-20260212-2000.md — VERIFIED.
- 2026-02-12: Agent-Dev TASK-0032 grid dark theme parity: theme wrapper применён ко всем 4 гридам. Build PASS. logs/dev-aggrid-dark-theme-20260212-1945.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0031 N3a1 UX feedback guaranteed: flash mechanism (setFlashSuccess→consumeFlash); min loader 280ms; Message на целевой странице после redirect. logs/debug-n3a1-ux-feedback-visible-20260212-1800.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0030 N3a1 contractor_create Save + UX feedback: Save сохраняет в Postgres; ScreenLoader при open; showLoading/showSuccess/showError при save. Backend: ctrUnp blank→null. logs/debug-n3a1-save-and-ux-feedback-20260212-1740.md — VERIFIED.
- 2026-02-12: Agent-Plan TASK-0029 Next screen + Contractors parity plan: Contractors list выбран; spec-pack docs/screens/contractors/; план унификации create/edit. logs/plan-next-screen-contractors-20260212-1900.md.
- 2026-02-12: Agent-QA TASK-0028 N3a+N3 full parity re-verify (Postgres-only + UX): **PASS**. N3a open 200, save invalid 400, save valid 200 + redirect; N3 POST data 200, список из Postgres, созданный договор (conId 9) в списке. Console 0 — ручная проверка. Лог: logs/qa-n3a-n3-postgres-parity-20260212-1715.md.
- 2026-02-12: Agent-Dev TASK-0026 Global Light/Dark theme toggle: ThemeContext + ThemeProvider, ConfigProvider algorithm, Segmented в Header, localStorage persist. Build PASS. logs/dev-theme-toggle-20260212-1830.md — VERIFIED.
- 2026-02-12: Agent-Dev TASK-0025A Global UX feedback Cursor Rule: 080-ux-feedback-global.mdc — Skeleton/Spin на загрузке; message.loading/success/error на async/mutations; запрет пустого feedback после Save; ссылки на shared layer. logs/dev-cursor-rule-ux-feedback-20260212-1820.md.
- 2026-02-12: Agent-Dev TASK-0025 Global UX feedback: shared lib (feedback, api error normalization), ScreenLoader (Skeleton), applies to N3a — open Skeleton, save Message.loading→success/error. logs/dev-global-ux-feedback-20260212-1815.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0024 N3a Save not persisting: list использовал fake data; ContractListProvider + Postgres для getData; save → list показывает новый договор. logs/debug-n3a-save-not-persisting-20260212-1850.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0023 N3a contractor validation: Form.Item+Space.Compact не передавал value в Select. Fix: nested Form.Item noStyle. logs/debug-n3a-contractor-validation-20260212-1800.md — VERIFIED.
- 2026-02-11: Agent-Dev TASK-0022 Dev dashboard UI: Data mode заменён на «DB Source: Live DB (Postgres)» + «Seed dataset: V21»; backend seedDataset из Flyway; FAKE_SEEDED не отображается. logs/dev-ui-devmode-livedb-20260211-1630.md — VERIFIED.
- 2026-02-11: Agent-Debug TASK-0021 Clean restart after Postgres-only: DB/backend/UI перезапущены; Flyway V20/V21 в flyway_schema_history; curl open/save 200; browser /contracts/new, /contractors/new открываются. logs/debug-restart-postgres-only-n3a-n3a1-20260211-1620.md — VERIFIED.
- 2026-02-11: Agent-Dev TASK-0020 Postgres-only N3a/N3a1: contractor create + contract create читают и пишут из Postgres; V20 dcl_reputation, V21 dev seed; ContractorCreateService/ContractCreateService на JPA; LastCreatedContractorHolder удалён; newContractorId via SELECT. logs/dev-postgres-only-n3a-n3a1-20260211-1615.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0019 N3a1+N3a contractor/contract save flow: Root cause — setSearchParams({}) в loadOpen вызывал refetch без newContractorId и сбрасывал contractor. Fix: удалён setSearchParams; contractor остаётся выбранным после return. logs/debug-n3a-contractor-contract-save-flow-20260212-1750.md — VERIFIED.
- 2026-02-12: Agent-QA TASK-0016 N3a1+N3a2 tab parity: **PASS (API)**. N3a1: open 200, 5 вкладок, save invalid 400, save valid 200. N3a2: open 200, 2 вкладки (Главная/Претензии), save invalid 400, save valid 200. Console 0 в браузере — ручная проверка. Лог: logs/qa-n3a1-n3a2-tabs-parity-20260212-1630.md.
- 2026-02-12: Agent-QA TASK-0015 N3a manual browser PASS (unblock TASK-0010): **PENDING_MANUAL**. Процедура ручной проверки в logs/qa-n3a-save-valid-manual-20260212-1620.md. Окружение доступно; автозаполнение не выполнено (snapshot без refs). N3a → PASS только после ручного подтверждения (save 200, редирект, Console 0).
- 2026-02-12: Agent-Debug TASK-0014 N3a/N3a1/N3a2 smoke-check: clean restart DB/backend/UI; все 3 страницы (/contracts/new, /contractors/new, /contracts/draft/specifications/new) открываются; open endpoints 200. logs/debug-n3a-n3a1-n3a2-smoke-20260212-1720.md — VERIFIED.
- 2026-02-12: Agent-Dev TASK-0013 N3a1+N3a2 full parity: contractor_create 5 табов, contract_spec_create 2 таба (Главная/Претензии); backend tabs + complaint; UI полные формы. Лог: logs/dev-n3a1-n3a2-full-parity-20260212-1505.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0011 N3a1 contractor_create Save flow: LastCreatedContractorHolder + open(newContractorId) добавляет нового контрагента в lookup; ContractCreatePage передаёт newContractorId в open; Save → redirect → contractor доступен и выбран. logs/debug-contractor-create-save-flow-20260212-1700.md — VERIFIED.
- 2026-02-12: Agent-QA TASK-0010 N3a Save valid rerun (browser + Console 0): **BLOCKED**. API save 200 подтверждён (curl UTF-8). Браузерная проверка (fill → Сохранить → редирект, Console 0) не выполнена — MCP snapshot не вернул refs для формы. PASS возможен только после ручной проверки в DevTools. Лог: logs/qa-n3a-save-valid-rerun-20260212-1615.md.
- 2026-02-12: Agent-Debug TASK-0009 N3a Save valid 400→200: root cause — Invalid UTF-8 (payload в CP1251); curl с UTF-8 payload → 200; CONTRACTS.md payload encoding; logs/debug-n3a-save-valid-20260212-1600.md — VERIFIED.
- 2026-02-11: Agent-QA TASK-0008 N3a contract_create + child flows full re-verify: **FAIL**. Save valid (POST /api/contracts/create/save) возвращает 400 Bad Request при теле из payloads/save-request.json; Open/Save invalid/N3a1/N3a2/N3a3 (list/upload/delete) — 2xx по CONTRACTS. Console не проверялся (ручная проверка). Лог: logs/qa-n3a-contract-create-full-20260211-1115.md.
- 2026-02-12: Agent-Dev TASK-0006 N3a missing blocks: плейсхолдеры на /contracts/new убраны; таблица Спецификации + кнопка «Создать спецификацию» (N3a2); блок Прикреплённые файлы + «Прикрепить» (N3a3); кнопка «Добавить» у контрагента (N3a1). Backend: draft spec open/save, draft attachments list/upload/delete (session), contractors create open/save. UI: ContractSpecCreatePage, ContractAttachmentsPage, ContractorCreatePage; маршруты и return flow по CONTRACTS. Лог: logs/dev-n3a-missing-blocks-20260212-1345.md — VERIFIED.
- 2026-02-12: Agent-Debug TASK-0007: Clean restart + visual smoke-check N3a. Окружение: DB + backend (8080) + UI (5173). Все 4 страницы (/contracts/new, /contractors/new?returnTo=contract, /contracts/draft/specifications/new, /contracts/draft/attachments) открываются; нет placeholder; API 200. logs/debug-n3a-visual-smoke-20260212-1410.md — VERIFIED.
- 2026-02-12: Agent-Plan TASK-0005: contractor_create, contract_spec_create, contract_attachments — полные spec packs (SNAPSHOT, CONTRACTS, ACCEPTANCE, BEHAVIOR_MATRIX, TEST_DATA_SPEC, QA_ROLE_PRESETS, payloads); N3a contract_create §6 Navigation. Лог: logs/plan-n3a-missing-blocks-specpack-20260212-1200.md.
- 2026-02-11: Agent-Plan TASK-0003 N3a parity audit: SNAPSHOT/ACCEPTANCE/BEHAVIOR_MATRIX/CONTRACTS пропатчены; stub packs contractor_create, contract_spec_create, contract_attachments. Plan gap: кнопка «Добавить»; Dev gaps: grid Спецификации, блок Прикреплённые файлы. Лог: logs/plan-contract-create-parity-audit-20260211-2300.md.
- 2026-02-11: Agent-Plan N3b contract_import_cp spec pack: CONTRACTS, ACCEPTANCE, BEHAVIOR_MATRIX, TEST_DATA_SPEC, QA_ROLE_PRESETS, payloads/network.har.BLOCKED.md. Traceability: SelectFromGridAction, CommercialProposalsAction, ContractAction.importCP. Лог: logs/plan-contract-import-cp-20260211-2100.md.
- 2026-02-11: Agent-QA N3a contract_create: BLOCKED. GET /api/contracts/create/open возвращает 404 (backend на 8080 без N3a create endpoints в момент прогона). Код и payloads соответствуют CONTRACTS. Отчёт: logs/qa-contract-create-20260211-1945.md. Рекомендация: перезапуск backend и повторный QA.
- 2026-02-11: Agent-Debug TASK-0001: N3a contract_create «Создать» navigation — VERIFIED. Причина 404: backend (PID 41972) запущен без N3a. Фикс: перезапуск backend. Клик «Создать» → /contracts/new, форма «Создание договора», open 200. logs/debug-contract-create-navigation-20260211-2200.md, docs/AGENT_TASK_REPORTS.md.
- 2026-02-11: Agent-Dev N3a contract create: GET /api/contracts/create/open, POST /api/contracts/create/save с валидацией (required, con_final_date при !conReusable&&seller.id=1, maxlength). UI /contracts/new — ContractCreatePage (форма 1:1 по SNAPSHOT, Отмена/Сохранить, редирект после save, вывод ошибок). Лог: logs/dev-contract-create-20260211-1135.md — VERIFIED.
- 2026-02-11: Agent-Grok TASK-0002: N3a contract_create UI layout polished (horizontal form, sections, widths, alignment). Log: logs/grok-contract-create-ui-layout-20260211-0900.md — VERIFIED.
- 2026-02-11: Agent-Debug TASK-0004: Grok UI changes not visible — причина: правки не были в рабочей копии (rg: no matches). Повторно применены: labelCol/wrapperCol, Divider «Основные поля», секции Спецификации/Прикреплённые файлы. VERIFIED в браузере. logs/debug-grok-ui-not-visible-20260211-2320.md.
- 2026-02-11: Agent-Plan N3a contract_create spec pack complete: SNAPSHOT (форма 1:1), CONTRACTS (open/save), ACCEPTANCE (7 сценариев), BEHAVIOR_MATRIX, TEST_DATA_SPEC, QA_ROLE_PRESETS, payloads (open, save request/response). Восстановлено из legacy ContractAction/Contract.jsp/ContractForm/validation.xml. Лог: logs/plan-contract-create-20260211-1900.md.
- 2026-02-11: Agent-Dev Contracts DB migrations: Flyway V12–V19 (dcl_department, dcl_language, dcl_seller, dcl_user, dcl_user_language, dcl_contractor, dcl_contract, dcl_con_list_spec). High-priority parity gap закрыт. DCL_CONTRACT_FILTER: application layer (docs/db/DCL_CONTRACT_FILTER_DECISION.md). Лог: logs/dev-contracts-db-migrations-20260211-1109.md — VERIFIED.
- 2026-02-11: Agent-QA N3 Contracts buttons re-verify: PASS. Кнопки «Импорт из КП» и «Создать» в gridBottom, порядок 1:1, клики → /contracts/import-cp и /contracts/new. canCreate из /api/me (admin/economist/lawyer). Отчёт: logs/qa-contracts-buttons-20260211-1855.md.
- 2026-02-11: Agent-Dev N3 buttons parity: кнопки «Импорт из КП» и «Создать» перенесены в gridBottom (под гридом), порядок слева направо; «Создать» видна только при ролях admin/economist/lawyer (/api/me); клики → /contracts/import-cp и /contracts/new. Лог: logs/dev-contracts-buttons-20260211-1805.md — VERIFIED.
- 2026-02-11: Agent-Plan N3 spec patch (buttons): SNAPSHOT §3.2 исправлен («Импорт из КП», placement gridBottom, traceability); ACCEPTANCE §8–9 (Click «Создать», «Импорт из КП»); BEHAVIOR_MATRIX Verify-столбец; CONTRACTS §0 Navigation; созданы docs/screens/contract_create/, contract_import_cp/ (N3a/N3b SNAPSHOT). Лог: logs/plan-contracts-buttons-patch-20260211-1700.md.
- 2026-02-11: Agent-Orchestrator N3 parity gap fixed: reopened N3, spec patch (ACCEPTANCE §13–14, BEHAVIOR_MATRIX), Dev implemented «Импорт из КП» и «Создать» кнопки + routes /contracts/new, /contracts/import-cp. Orchestrator log: logs/orchestrator-contracts-parity-gap-20260211-1600.md. Browser: /contracts, /contracts/new, /contracts/import-cp load OK.
- 2026-02-11: Agent-QA N3 Contracts list parity: PASS (до обнаружения gap по кнопкам). Backend запущен (port 8080 освобождён, Flyway OK); GET lookups, POST data/page/cleanAll — 2xx, JSON по CONTRACTS и payloads; сценарии ACCEPTANCE/BEHAVIOR_MATRIX проверены. Отчёт: logs/qa-contracts-20260211-0940.md. Console — ручная проверка (Preserve log) рекомендована.
- 2026-02-10: N3 Contracts list реализован 1:1: backend (GET lookups, POST data/page/cleanAll, FAKE_SEEDED 60 строк по TEST_DATA_SPEC), UI (маршрут /contracts, меню «Договора», фильтры, грид 15 стр/стр, next/prev, crossed-cell). Сборка и тесты backend — OK. Browser-verify не выполнен: backend не запускается из‑за Flyway (миграции 10, dev seed marker). Лог: logs/dev-contracts-20260210-1740.md — NOT VERIFIED.
- 2026-02-10: Orders N2 parity gaps fixed: contractor_for_id filter (provider+service+tests), order_by=ord_number asc/desc (provider+tests), UI sort dropdown; browser-verified. logs/dev-orders-parity-fix-20260210-1532.log — VERIFIED.
- 2026-02-10: Agent-Plan N2 spec pack (Orders list): docs/screens/orders/ created — SNAPSHOT.md, CONTRACTS.md, ACCEPTANCE.md, BEHAVIOR_MATRIX.md, payloads/README.md; traceability to OrdersAction, OrdersForm, Orders.jsp, select-orders → DCL_ORDER_FILTER; UNCONFIRMED + "How to verify" in CONTRACTS; payloads/list-request.json, list-response.json (example shapes). PROGRESS.md updated. Agent-Plan verification pass: spec pack complete for 1:1 implementation.
- 2026-02-10: Agent-Plan prepared full N3 Contracts spec pack in `docs/screens/contracts/` (SNAPSHOT/CONTRACTS/ACCEPTANCE/BEHAVIOR_MATRIX/TEST_DATA_SPEC/QA_ROLE_PRESETS + payloads + screenshots README), with BLOCKED HAR capture notes and HOW TO VERIFY steps.
- 2026-02-10: Agent-Plan prepared spec package for Margin-first dev cycle: `docs/security/ROLE_MODEL.md`, `docs/security/DEV_BYPASS.md`, `docs/db/SEED_DATA_PLAN.md`, `docs/dev/DEV_DASHBOARD_SPEC.md`; defined role model, dev bypass headers + `/api/me`, seed marker/dataMode, and `/dev` dashboard contract.
- 2026-02-10: Done - Plan validation for Orders pack complete (`docs/screens/orders/*`): contracts/acceptance/matrix tightened to legacy 1:1, top-5 parity risks documented with verification steps, payload samples expanded for filters/sort/pagination/reload.
- Completed Phase 1 QC (procedures, PK/UK, feature traceability).
- Scaffolded modern backend with Country aggregate, endpoints, Flyway migration, and Testcontainers integration test.
- Added Postgres docker-compose and deployment guide.
- Started modern UI with table/grid consuming generated OpenAPI types.
- 2026-02-09: Added Cursor Project Rules (`.cursor/rules/*.mdc`) enforcing CONTINUITY workflow, bash-only, sources of truth, Modulith, Flyway, tests, docs discipline.
- 2026-02-09 Dev run: logs/ (dev-env-diagnostics, dev-backend-build, dev-backend-test, dev-backend-run, dev-ui-install, dev-ui-run, dev-db-up, dev-db-ps). Backend: build OK with JAVA_HOME=JDK 21; tests OK (CountryIntegrationTest skipped when Docker unavailable); run fails without Postgres. UI: npm install OK; generate:api requires backend on :8080; npm run dev OK (Vite 5173). Docker Desktop was not running; docker-compose fixed (removed version). DEPLOYMENT_GUIDE updated with prerequisites.
- 2026-02-09: Cursor Rules enforcement check. Verified `.cursor/rules/*.mdc` present; 000-continuity-always requires "read CONTINUITY.md" at start. Practical check: added Currency module (api/application/domain/infrastructure), no cross-module refs, Flyway V2__init_currency.sql from DDL, integration test, traceability comment in controller.
- 2026-02-09: Margin legacy snapshot captured (HAR + spec; screenshots pending capture).
- 2026-02-09 E2E dev1: docker info OK; docker compose -f ops/docker-compose.yml up -d OK; Postgres 16 up. Backend: added flyway-database-postgresql (Postgres 16 support), Currency noRound/sortOrder SMALLINT→Short + DTO conversion, Flyway V3/V4 (event_publication, event_publication_archive). Backend starts and serves /v3/api-docs, GET/POST /api/countries, GET/POST /api/currencies verified. UI: npm install, npm run generate:api, npm run dev OK. Logs: logs/dev1-*.
- 2026-02-09 UI: Vite proxy (/api, /v3, /swagger-ui → :8080); table/grid; Countries grid displays real data from Postgres (CountryRepository.findAll()). Stage recorded: dev only, production not yet.
- Margin screen (Отчеты → Маржа): route /reports/margin and menu added; SNAPSHOT.md and payloads absent — parity implementation blocked. Created docs/screens/margin/ (SNAPSHOT stub, payloads/README, IMPLEMENTATION_NOTES.md), UI placeholder page with blocker message. Backend margin module and full UI deferred until Agent-Plan provides spec.
- 2026-02-09: Merged origin/main; resolved CONTINUITY.md and SNAPSHOT.md; committed margin snapshot (full spec, HAR, payloads); pushed main → origin/stage.
- 2026-02-09: Margin specs finalized (CONTRACTS + ACCEPTANCE + BEHAVIOR_MATRIX) and SNAPSHOT updated with links.
- 2026-02-09: Margin parity implemented (fake data): backend margin modulith (api/application/domain/infrastructure), GET/POST /api/margin/data, generate, cleanAll, export/excel, lookups; UI full screen (filters, 28-column grid, toolbar, row styles, loading/error) per ACCEPTANCE + BEHAVIOR_MATRIX; IMPLEMENTATION_NOTES checklist; logs/* placeholders.
- 2026-02-09: QA parity report produced (docs/screens/margin/QA_PARITY_REPORT.md): 3 blockers (view_* not wired, onlyTotal rules, cleanAll get_not_block), 2 non-blocking diffs, UNCONFIRMED for dynamic/error text.
- 2026-02-09: Margin QA blockers fixed: (1) view_* checkboxes in UI, viewFlags state init from response.view, columnDefs hide from viewFlags, Generate sends view; (2) onlyTotal auto-uncheck when !hasOneSelector (useEffect), onlyTotal checked → itog_by_spec unchecked; (3) cleanAll onSuccess setGetNotBlock(false). IMPLEMENTATION_NOTES and logs/dev-margin-blockers-fix-notes.log updated.
- 2026-02-09: Added Cursor rule 070-browser-verification.mdc: mandatory smoke-check in browser after UI/API changes; VERIFIED/NOT VERIFIED log in logs/dev-browser-check-*.log; procedure bash-only.
- 2026-02-09: Added Cursor rule 071-no-user-verification.mdc: Agent-Dev сам проверяет E2E в браузере; запрещено просить пользователя; доказательства в logs/dev-e2e-verify-*.log; Done только при VERIFIED или BLOCKED с причиной.
- 2026-02-09: Added Cursor rule 072-no-blank-screens.mdc: запрет пустых/сломанных страниц; smoke-check после UI-правок (Console, DOM, "page not blank"); лог logs/dev-ui-smoke-*.log; при FAIL — фикс или revert; fallback Loading/Error в UI.
- 2026-02-09: Margin real progress loader (no fake): useMarginProgress + MarginProgress UI; initial (5 lookups steps), generate (request/response/render), export (XHR onprogress + steps); downloadWithProgress.ts; log dev-margin-progress-loader-20260209.log; IMPLEMENTATION_NOTES updated.
- 2026-02-09: Added Cursor rule 073-fixed-dev-ports.mdc: порты фиксированы UI=5173, BE=8080, DB=5432; запрет тихого переезда; при занятом порте — lsof, kill или BLOCKED; vite.config.ts strictPort: true; лог logs/dev-ports-*.log.
- 2026-02-09: Added Cursor rule 074-java-21-mandatory.mdc: backend только JDK 21; перед build/test/run — which java, java -version, JAVA_HOME; Java 8/11/17 = BLOCKED; лог logs/dev-java-gate-*.log; Done только при PASS + mvnw test + spring-boot:run на :8080.
- 2026-02-11: Added Cursor rule 075-mandatory-task-reporting.mdc: обязательный TASK ID (TASK-0001..) и отчет в docs/AGENT_TASK_REPORTS.md; в начале — Agent/Start, в конце — End/Done/Files/Artifacts/Status; при отсутствии ID — генерация по grep; Done только при заполненной секции и артефакте; anti-loop guard. Создан docs/AGENT_TASK_REPORTS.md.
- 2026-02-11: Added Cursor rule 076-agent-role-explicit.mdc: каждый промпт для агента MUST начинаться с явной роли ROLE: <Concrete role> (Seniority; Focus); формат и примеры (QA, Backend, UI/UX, Debug, Spec Analyst); при отсутствии ROLE — задача неполная.
- 2026-02-11: Agent-Dev TASK-0052 contractor_create Tabs validation UX: глобальные действия «Сохранить/Отмена»; validateAllTabs on Save; Badge на вкладках с ошибками; auto-switch на первую вкладку с ошибкой; sticky footer; notification.error/success. logs/dev-contractor-tabs-validation-ux-20260211-2249.md.

Now:
- Role-checkers baseline расширен: backend guardrails для contractors create/edit open/save + UI отправляет role-header во все form-запросы.
- Runtime backend smoke всё ещё ограничен отсутствием docker/postgres.
Next:
- Сверить policy-матрицу ролей contractors с legacy evidence (не только admin/user baseline) и добавить granular permissions.
- Прогнать full backend suite с Docker/Testcontainers и зафиксировать smoke-артефакты.
