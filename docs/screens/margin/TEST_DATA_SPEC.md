# Margin: Детерминированный набор тестовых данных для паритета

Цель: один и тот же набор seed-данных позволяет проверять экран «Отчеты → Маржа» по ACCEPTANCE и BEHAVIOR_MATRIX без угадываний и рандома. Все значения детерминированы; в данных есть явные «маячки» для QA.

Связь с планом seed: `docs/db/SEED_DATA_PLAN.md` (секция «Margin parity dataset»).

---

## A) Минимальный набор справочников

Объёмы и поля достаточны для фильтров Margin и проверки ограничений по ролям (ROLE_MODEL).

### Users (DCL_USER + DCL_USER_LANGUAGE + DCL_USER_ROLE)

| Количество | Зачем |
|-----------|--------|
| 4–5       | admin, manager, manager_chief, economist + один «другой» для фильтра по пользователю |

Критичные поля: `USR_ID`, `DEP_ID`, `USR_CHIEF_DEP`, отображаемое имя (через DCL_USER_LANGUAGE). Связь с DCL_USER_ROLE: 1=admin, 2=manager, 4=economist.

Комбинации для ролей:
- Один пользователь с `USR_CHIEF_DEP=1` и валидным `DEP_ID` — проверка Users lookup с `dep_id` (chief dep).
- Пользователи в разных департаментах — проверка фильтра по департаменту и ограничений manager.

### Departments (DCL_DEPARTMENT)

| Количество | Зачем |
|-----------|--------|
| 2–3       | Два департамента для dev_manager / dev_economist; третий опционально для «другого» контекста |

Критичные поля: `DEP_ID`, `DEP_NAME`. Имена с суффиксом `(DEV)` для распознавания.

### Contractors (DCL_CONTRACTOR + страна/тип по DDL)

| Количество | Зачем |
|-----------|--------|
| 3–5       | Минимум два для фильтра «контрагент»; остальные — разные «маячки» (Contractor A, Contractor B, и т.д.) |

Критичные поля: `CTR_ID`, имя, `RPT_ID`, `CUT_ID` (по DDL). Имена детерминированные, например «ООО Контрагент-A (DEV)», «ООО Контрагент-B (DEV)».

### Routes (DCL_ROUTE)

| Количество | Зачем |
|-----------|--------|
| 2–3       | Разные маршруты для фильтра и для отображения колонки маршрута в гриде |

Критичные поля: `RUT_ID`, `RUT_NAME`. Маячки: «Маршрут Минск–РБ (DEV)», «Маршрут Минск–EU (DEV)».

### Stuff categories (DCL_STUFF_CATEGORY)

| Количество | Зачем |
|-----------|--------|
| 2–3       | Фильтр «категория товара» и колонка в гриде с разными значениями (0 / null / число для view_*) |

Критичные поля: `STF_ID`, `STF_NAME`. Маячки: «Категория-A (DEV)», «Категория-B (DEV)».

---

## B) Набор строк «margin data» (покрытие сценариев)

Данные должны возвращаться процедурой `dcl_margin` / `dcl_margin1` (или эквивалентом в Postgres) в выбранном диапазоне дат. Объём и значения подобраны так, чтобы проверить все ключевые сценарии.

### Объём

- Минимум **25–40 строк** в одном наборе фильтров (даты + один селектор), чтобы:
  - была вторая страница пагинации (например, pageSize=25);
  - работала сортировка по разным колонкам на реальных данных.

### Сценарии и «маячки» в данных

1. **onlyTotal**  
   - Часть строк — итоговые (`itogLine: true`).  
   - Маячок: при включённом onlyTotal и выборе «в разрезе» по пользователю/департаменту/контрагенту/категории/маршруту видны только итоги (без детализации по договорам/спецификациям), где так задумано логикой MarginAction.

2. **itog_by_spec / itog_by_user / itog_by_product**  
   - В данных есть несколько пользователей, несколько категорий, несколько контрагентов.  
   - Маячки: разные `usr_name_show`, `stf_name_show`, `ctr_name` в строках, чтобы при включении соответствующих itog_* группировки и итоговые строки были заметны.

3. **get_not_block**  
   - Часть записей с «незаблокированными» признаками (`haveUnblockedPrc: true`), часть — заблокированные.  
   - Маячок: при снятии get_not_block число строк уменьшается (или состав меняется); при включённом get_not_block видны строки с розовой/градиентной подсветкой (по BEHAVIOR_MATRIX / row styles).

4. **Сортировка и пагинация**  
   - 25–40 строк с разными значениями в ключевых колонках (даты, суммы, имена), чтобы смена порядка и переключение страницы давали предсказуемый результат.

5. **view_* (видимость колонок)**  
   - В данных должны быть колонки, где значение иногда 0, иногда null, иногда непустое число/строка, чтобы скрытие/показ колонки было заметно.  
   - Маячки: например, у части строк `lcc_montage_formatted` или `view_montage_time` пустые, у части — заполнены; аналогично для других view_* полей (transport, custom, koeff и т.д.).

6. **Стили строк (itogLine, spc_group_delivery, haveUnblockedPrc)**  
   - Несколько строк с `itogLine: true` (жирная строка).  
   - Несколько с `spc_group_delivery` непустым (зелёный фон).  
   - Несколько с `haveUnblockedPrc: true` (розовый или зелёный+розовый при наличии spc_group_delivery).  
   Маячки: фиксированные контрагенты/номера спецификаций, по которым в тестовом наборе гарантированно есть такие строки.

### Детерминизм

- Все ID, даты, суммы — фиксированные (без random).  
- Даты в узком диапазоне, например 2024-01-01 … 2024-01-31, чтобы один и тот же seed всегда давал один и тот же результат при тех же фильтрах.  
- Имена с суффиксом `(DEV)` или префиксом «Контрагент-A», «Маршрут Минск–РБ» и т.п., чтобы в UI сразу было видно, что отображаются тестовые данные.

---

## C) Связь с SEED_DATA_PLAN и DDL

### Таблицы по DDL, которые должны быть засеяны

Чтобы margin-данные существовали и процедура (или её эквивалент) возвращала строки, по `db/Lintera_dcl-5_schema.ddl` и `docs/db/SEED_DATA_PLAN.md` нужны:

- **Справочники:** DCL_USER, DCL_USER_LANGUAGE, DCL_USER_ROLE, DCL_DEPARTMENT, DCL_CONTRACTOR, DCL_ROUTE, DCL_STUFF_CATEGORY, DCL_CURRENCY (и при необходимости страна/тип контрагента по DDL).
- **Доменная цепочка margin:** DCL_CONTRACT, DCL_CON_LIST_SPEC, DCL_SHIPPING, DCL_PRC_LIST_PRODUCE, DCL_SHP_LIST_PRODUCE (и связанные по DDL), DCL_LPS_LIST_MANAGER, DCL_CONTRACT_CLOSED, DCL_CTC_LIST, DCL_CTC_SHP, DCL_PAYMENT, DCL_PAY_LIST_SUMM, DCL_CTC_PAY, DCL_PRODUCE_COST (или эквиваленты в Postgres).

Точный список таблиц и полей — по `docs/db/SEED_DATA_PLAN.md` и текущим Flyway-миграциям.

### Если в Phase 2 части таблиц ещё нет

- Временно допускается **временный источник данных** (например, in-memory или отдельная таблица-заглушка), чтобы:
  - UI и API Margin работали с детерминированным набором строк;
  - сценарии ACCEPTANCE/BEHAVIOR_MATRIX (onlyTotal, itog_*, get_not_block, view_*, пагинация, сортировка) можно было проверять.
- Такое решение **обязательно** помечать как **временное** в коде и в документации, с явной пометкой: «в будущем заменяется реальными таблицами и процедурой dcl_margin / dcl_margin1».

---

## Итог

- QA поднимает систему с seed по этой спецификации и SEED_DATA_PLAN.  
- Выставляет preset ролей (см. `docs/screens/margin/QA_ROLE_PRESETS.md`).  
- Проверяет Margin по ACCEPTANCE и BEHAVIOR_MATRIX: фильтры, Generate, Clear all, onlyTotal, itog_*, get_not_block, view_*, пагинация, сортировка, экспорт, ошибки.  
- Все данные детерминированы; «маячки» в именах и типах строк позволяют однозначно убедиться, что сценарий сработал.
